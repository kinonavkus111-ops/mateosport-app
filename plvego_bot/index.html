<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>PLVEGO Mini App</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #0088cc;
    }
    .button {
      background-color: #0088cc;
      color: white;
      padding: 15px 25px;
      margin: 15px 0;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      cursor: pointer;
      user-select: none;
      display: inline-block;
      width: 100%;
      box-sizing: border-box;
      text-decoration: none;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-bottom: 10px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>PLVEGO</h1>

  <div id="menu">
    <div class="button" onclick="openSearch()">
      üîç –ù–∞–π—Ç–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
    </div>

    <div class="button" onclick="openProfile()">
      üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
    </div>
  </div>

  <div id="search" class="hidden"></div>
  <div id="profile" class="hidden"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    function goBack(fromId) {
      document.getElementById(fromId).classList.add("hidden");
      document.getElementById("menu").classList.remove("hidden");
    }

    function openSearch() {
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("profile").classList.add("hidden");
      document.getElementById("search").classList.remove("hidden");

      document.getElementById("search").innerHTML = `
        <div>
          <div class="button" onclick="goBack('search')">‚¨Ö –ù–∞–∑–∞–¥</div>
          <h2>–ü–æ–∏—Å–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É</h2>

          <input type="text" id="searchCityInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥">
          <div class="button" onclick="searchByCity()">–ü–æ–∏—Å–∫</div>

          <div id="searchResults"></div>
        </div>
      `;
    }

    function openProfile() {
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("search").classList.add("hidden");
      document.getElementById("profile").classList.remove("hidden");

      // –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è —É –±–æ—Ç–∞
      tg.sendData(JSON.stringify({command: 'get_profile'}));

      // –ü–æ–∫–∞ –ø—É—Å—Ç–æ, –∂–¥–µ–º –æ—Ç–≤–µ—Ç
      document.getElementById("profile").innerHTML = `
        <div>
          <div class="button" onclick="goBack('profile')">‚¨Ö –ù–∞–∑–∞–¥</div>
          <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
      `;
    }

    function searchByCity() {
      const city = document.getElementById('searchCityInput').value.trim();
      if (!city) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥');
        return;
      }

      document.getElementById('searchResults').innerHTML = '<p>–ò–¥—ë—Ç –ø–æ–∏—Å–∫...</p>';

      tg.sendData(JSON.stringify({command: 'search_partner', city: city}));
    }

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞
    window.Telegram.WebApp.onEvent('web_app_data', function(data) {
      try {
        const resp = JSON.parse(data.data);

        if (resp.type === 'search_results') {
          let users = resp.users;
          let html = '';

          if (!users || users.length === 0) {
            html = '<p>–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —Å —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
          } else {
            users.forEach(u => {
              let chatLink = u.username ? `https://t.me/${u.username}` : `tg://user?id=${u.userId || ''}`;

              html += `<div class="card">
                          <b>${u.fullName}</b><br>
                          <span>–ì–æ—Ä–æ–¥: ${u.city}</span><br>
                          <span>–í–∏–¥ —Å–ø–æ—Ä—Ç–∞: ${u.activity}</span><br>
                          <span>–í–æ–∑—Ä–∞—Å—Ç: ${u.age}</span><br>
                          <span>–£—Ä–æ–≤–µ–Ω—å: ${u.level}</span><br>
                          ${u.username ? `<a href="${chatLink}" target="_blank" class="button">–ù–∞–ø–∏—Å–∞—Ç—å</a>` : '<small>–ù–µ—Ç username –¥–ª—è —Å–≤—è–∑–∏</small>'}
                       </div>`;
            });
          }

          document.getElementById('searchResults').innerHTML = html;

        } else if (resp.type === 'profile') {
          const p = resp.profile;
          let chatLink = p.username ? `https://t.me/${p.username}` : `tg://user?id=${p.userId || ''}`;

          document.getElementById("profile").innerHTML = `
            <div>
              <div class="button" onclick="goBack('profile')">‚¨Ö –ù–∞–∑–∞–¥</div>
              <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
              <div class="card">
                <b>${p.fullName}</b><br>
                <span>–ì–æ—Ä–æ–¥: ${p.city}</span><br>
                <span>–í–∏–¥ —Å–ø–æ—Ä—Ç–∞: ${p.activity}</span><br>
                <span>–í–æ–∑—Ä–∞—Å—Ç: ${p.age}</span><br>
                <span>–£—Ä–æ–≤–µ–Ω—å: ${p.level}</span><br>
                ${p.username ? `<a href="${chatLink}" target="_blank" class="button">–ù–∞–ø–∏—Å–∞—Ç—å —Å–µ–±–µ</a>` : '<small>–ù–µ—Ç username</small>'}
              </div>
            </div>
          `;
        }
      } catch(e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞", e);
      }
    });
  </script>
</body>
</html>